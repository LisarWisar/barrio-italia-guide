<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive 3D Scene</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #111827; /* bg-gray-900 */
        }
        canvas {
            display: block;
        }
        #info {
            position: absolute;
            top: 40px;
            width: 100%;
            text-align: center;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 1.125rem; /* text-lg */
        }
        #tooltip {
            position: absolute;
            display: none;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            pointer-events: none; /* So it doesn't interfere with mouse events on the canvas */
            font-family: 'Inter', sans-serif;
            transform: translate(-50%, -120%); /* Offset to appear above the cursor */
        }
        /* Style for the modal to fit the dark theme */
        .modal-content {
            background-color: #2d3748;
            color: white;
        }
        .modal-header {
            border-bottom: 1px solid #4a5568;
        }
        .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        .navbar-go-back-button{
            background-color: #cec4c4;
            color: black;
            border-radius: 8px;
        }
        .navbar-go-back-button:hover{
            background-color: #DC8454;
            color: black;
        }
    </style>
</head>
<body>
    <a href="index.html">
        <button class="navbar-go-back-button">Volver</button>
    </a>
    <div id="info">Use your mouse to navigate the scene.</div>
    <div id="tooltip"></div>
    <canvas id="bg"></canvas>

    <!-- Bootstrap Modal HTML -->
     <div class="modal fade" id="cubeModal" tabindex="-1" aria-labelledby="cubeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="card">
                    <img src="images/Banner.png" class="card-img-top" alt="...">
                    <div class="card-body">
                       <div>
                        <h2 class="text-center mb-3" id="shopTitle"></h2>
                        <p class="modal-address mb-0 fw-light" id="shopAddress"></p>
                        <p id="shopDescription"></p>
                       </div>
                       <div id="carouselExample" class="carousel slide">
                            <div class="carousel-inner">
                                <div class="carousel-item active">
                                <img src="images/Foto.png" class="d-block w-100" alt="...">
                                </div>
                                <div class="carousel-item">
                                <img src="images/Foto.png" class="d-block w-100" alt="...">
                                </div>
                                <div class="carousel-item">
                                <img src="images/Foto.png" class="d-block w-100" alt="...">
                                </div>
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn shop-modal-close-button" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- <div class="modal fade" id="cubeModal" tabindex="-1" aria-labelledby="cubeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cubeModalLabel"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="cubeModalBody">
                </div>
            </div>
        </div>
    </div> -->

    <!-- Import Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- IMPORTANT: Add support for loading FBX files and OrbitControls -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/"
            }
        }
    </script>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script type="module">
        // NEW: Import the FBX and OrbitControls Loaders
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // Basic Scene Setup
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({
            canvas: document.querySelector('#bg'),
            antialias: true,
        });

        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.position.setZ(15); // Move camera back a bit to see the model

        // --- NEW: Add OrbitControls for free camera movement ---
        const controls = new OrbitControls(camera, renderer.domElement);
   /*      controls.enableDamping = true; // Makes movement feel smoother
        controls.dampingFactor = 0.05; */
        controls.screenSpacePanning = false;
        controls.minDistance = 5;
        controls.maxDistance = 50;

        // --- Create a group to hold the objects ---
        const objectGroup = new THREE.Group();
        scene.add(objectGroup);

        // --- Shops Information --
        const basicShopColor = 0xC1B36F;
        const selectedShopColor = 0xDC8454;
        const residentialColor = 0xCEC4C4;
        const floorColor = 0x9A8585;

        const shopsID = [1,2,3,4,5,6,7];
        const shopsNameID = shopsID.map((id) => 'galeria_1_tienda_' + id)
        const shopDefaultTitle = "Tienda";
        const shopDefaultDescription = "Esta es una tienda"
        const defaultAddress = "Calle Falsa 123"

        // --- FBX MODEL LOADING ---
        const loader = new FBXLoader();
        loader.load('modelos_fbx/galeria_1_interior.fbx', function (fbx) {
            
            fbx.traverse(function (child) {
                console.log(child.name)

                if (child.isMesh) {
                    if(shopsNameID.includes(child.name)){
                        child.material = new THREE.MeshStandardMaterial({ color: basicShopColor });
                        child.userData = { 
                            action: 'modal',
                            id: child.name,
                            originalColor: basicShopColor, 
                            hoverColor: selectedShopColor, 
                            hoverText: shopDefaultTitle,
                            shopDescription: shopDefaultDescription,
                            shopAddress: defaultAddress
                        };
                    }
                    else if (child.name == "galeria_1_piso"){
                        child.material = new THREE.MeshStandardMaterial({ color: floorColor });
                    }
                    
                    // --- Setup residential building ---
                    else{
                        child.material = new THREE.MeshStandardMaterial({ color: residentialColor });
                    }
                
                    /* if (child.name === 'galeria_1_tienda_1') {
                         const originalColor = 0x8A2BE2;
                         const hoverColor = 0x32CD32;
                         child.material = new THREE.MeshStandardMaterial({ color: originalColor });
                         
                         child.userData = { 
                            action: 'modal',
                            originalColor: originalColor, 
                            hoverColor: hoverColor, 
                            hoverText: 'Tienda 1',
                            shopDescription: 'Esta es la descripción para la Tienda 1.'
                        };
                    }
                    if (child.name === 'galeria_1_tienda_2') {
                         const originalColor = 0x8A2BE2;
                         const hoverColor = 0x32CD32;
                         child.material = new THREE.MeshStandardMaterial({ color: originalColor });
                         
                         child.userData = { 
                            action: 'modal',
                            originalColor: originalColor, 
                            hoverColor: hoverColor, 
                            hoverText: 'Tienda 2',
                            shopDescription: 'Esta es la descripción para la Tienda 2.'
                        };
                    }
                    if (child.name === 'galeria_1_tienda_3') {
                         const originalColor = 0x8A2BE2;
                         const hoverColor = 0x32CD32;
                         child.material = new THREE.MeshStandardMaterial({ color: originalColor });
                         
                         child.userData = { 
                            action: 'modal',
                            originalColor: originalColor, 
                            hoverColor: hoverColor, 
                            hoverText: 'Tienda 3',
                            shopDescription: 'Esta es la descripción para la Tienda 3.'
                        };
                    }
                    if (child.name === 'galeria_1_tienda_4') {
                         const originalColor = 0x8A2BE2;
                         const hoverColor = 0x32CD32;
                         child.material = new THREE.MeshStandardMaterial({ color: originalColor });
                         
                         child.userData = { 
                            action: 'modal',
                            originalColor: originalColor, 
                            hoverColor: hoverColor, 
                            hoverText: 'Tienda 4',
                            shopDescription: 'Esta es la descripción para la Tienda 4.'
                        };
                    }
                    if (child.name === 'galeria_1_tienda_5') {
                         const originalColor = 0x8A2BE2;
                         const hoverColor = 0x32CD32;
                         child.material = new THREE.MeshStandardMaterial({ color: originalColor });
                         
                         child.userData = { 
                            action: 'modal',
                            originalColor: originalColor, 
                            hoverColor: hoverColor, 
                            hoverText: 'Tienda 5',
                            shopDescription: 'Esta es la descripción para la Tienda 5.'
                        };
                    }
                    if (child.name === 'galeria_1_tienda_6') {
                         const originalColor = 0x8A2BE2;
                         const hoverColor = 0x32CD32;
                         child.material = new THREE.MeshStandardMaterial({ color: originalColor });
                         
                         child.userData = { 
                            action: 'modal',
                            originalColor: originalColor, 
                            hoverColor: hoverColor, 
                            hoverText: 'Tienda 6',
                            shopDescription: 'Esta es la descripción para la Tienda 6.'
                        };
                    }
                    if (child.name === 'galeria_1_tienda_7') {
                         const originalColor = 0x8A2BE2;
                         const hoverColor = 0x32CD32;
                         child.material = new THREE.MeshStandardMaterial({ color: originalColor });
                         
                         child.userData = { 
                            action: 'modal',
                            originalColor: originalColor, 
                            hoverColor: hoverColor, 
                            hoverText: 'Tienda 7',
                            shopDescription: 'Esta es la descripción para la Tienda 7.'
                        };
                    } */
                }
            });

            // Add the loaded model to the group
            objectGroup.add(fbx);

        }, undefined, function (error) {
            console.error(error);
            document.getElementById('info').textContent = "Error: Could not load 3D model. Check console for details.";
        });


        // --- Lighting ---
        const pointLight = new THREE.PointLight(0xffffff, 1.2);
        pointLight.position.set(20, 20, 20);
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(pointLight, ambientLight);


        // --- Interactivity Setup ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let intersectedObject = null;
        
        // --- Bootstrap Modal Instance ---
        const cubeModal = new bootstrap.Modal(document.getElementById('cubeModal'));

        function onMouseMove(event) {
            // Update mouse coordinates for raycasting
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
        }

        function onClick(event) {
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(objectGroup.children, true);

            if (intersects.length > 0) {
                const clickedObject = intersects[0].object;
                
                // Perform action based on custom user data
                if (clickedObject.userData.action === 'navigate') {
                    window.location.href = clickedObject.userData.url;

                } else if (clickedObject.userData.action === 'modal') {
                    const modalBody = document.getElementById('shopDescription');
                    modalBody.textContent = clickedObject.userData.shopDescription;

                    const modalTitle = document.getElementById('shopTitle');
                    modalTitle.textContent = clickedObject.userData.hoverText;

                    const modalAddress = document.getElementById('shopAddress');
                    modalAddress.textContent = clickedObject.userData.shopAddress;
                    cubeModal.show();
                }
            }
        }
        
        // --- Event Listeners ---
        window.addEventListener('mousemove', onMouseMove, false);
        window.addEventListener('click', onClick, false);


        // --- Responsiveness ---
        window.addEventListener('resize', onWindowResize, false);

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);

            // Required for smooth camera controls
            controls.update();

            // --- Hover Logic ---
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(objectGroup.children, true);

            let newIntersectedObject = null;
            // Find the first object that has our custom data
            for (let i = 0; i < intersects.length; i++) {
                if (intersects[i].object.userData.action) {
                    newIntersectedObject = intersects[i].object;
                    break;
                }
            }

            if (intersectedObject !== newIntersectedObject) {
                if (intersectedObject) {
                    intersectedObject.material.color.set(intersectedObject.userData.originalColor);
                }
                intersectedObject = newIntersectedObject;
                if (intersectedObject) {
                     intersectedObject.material.color.set(intersectedObject.userData.hoverColor);
                }
            }
            
            // --- Tooltip Logic ---
            const tooltip = document.getElementById('tooltip');
            if (intersectedObject) {
                tooltip.style.display = 'block';
                tooltip.textContent = intersectedObject.userData.hoverText;

                // --- NEW ROBUST TOOLTIP POSITIONING ---
                // Create a bounding box to find the object's visual center
                const box = new THREE.Box3().setFromObject(intersectedObject);
                const center = box.getCenter(new THREE.Vector3());

                // Project the center point to 2D screen space
                center.project(camera);

                const translateX = (center.x * 0.5 + 0.5) * renderer.domElement.clientWidth;
                const translateY = (-center.y * 0.5 + 0.5) * renderer.domElement.clientHeight;
                
                tooltip.style.left = translateX + 'px';
                tooltip.style.top = translateY + 'px';
            } else {
                tooltip.style.display = 'none';
            }


            renderer.render(scene, camera);
        }

        // Start the animation
        animate();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive 3D Scene</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #111827; /* bg-gray-900 */
        }
        canvas {
            display: block;
        }
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            z-index: 100;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 1.125rem; /* text-lg */
        }
        #tooltip {
            position: absolute;
            display: none;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            pointer-events: none; /* So it doesn't interfere with mouse events on the canvas */
            font-family: 'Inter', sans-serif;
            transform: translate(-50%, -120%); /* Offset to appear above the cursor */
        }
        /* Style for the modal to fit the dark theme */
        .modal-content {
            background-color: #f2eaea;
            color: black;
            border: 2px solid #cec4c4;
        }
        .modal-header {
            border-bottom: 1px solid #cec4c4;
        }
        .card-body{
            background-color: #f2eaea;
            color: black;
            border: 1px solid #cec4c4;
        }
        .btn-close {
            /* filter: invert(1) grayscale(100%) brightness(200%); */
            color: black;
        }
        .modal-address{
            font-size: smaller;
        }
        .shop-modal-close-button{
            background-color: #cec4c4;
            color: black;
            margin-top: 16px;
        }
        .shop-modal-close-button:hover{
            background-color: #DC8454;
            color: black;
        }
    </style>
</head>
<body>

    <div id="info">Use your mouse to navigate the scene.</div>
    <div id="tooltip"></div>
    <canvas id="bg"></canvas>

    <!-- Bootstrap Modal HTML -->
    <div class="modal fade" id="cubeModal" tabindex="-1" aria-labelledby="cubeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="card">
                    <img src="images/Banner.png" class="card-img-top" alt="...">
                    <div class="card-body">
                       <div>
                        <h2 class="text-center mb-3" id="shopTitle"></h2>
                        <p class="modal-address mb-0 fw-light" id="shopAddress"></p>
                        <p id="shopDescription"></p>
                       </div>
                       <div id="carouselExample" class="carousel slide">
                            <div class="carousel-inner">
                                <div class="carousel-item active">
                                <img src="images/Foto.png" class="d-block w-100" alt="...">
                                </div>
                                <div class="carousel-item">
                                <img src="images/Foto.png" class="d-block w-100" alt="...">
                                </div>
                                <div class="carousel-item">
                                <img src="images/Foto.png" class="d-block w-100" alt="...">
                                </div>
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn shop-modal-close-button" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- IMPORTANT: Add support for loading FBX files and OrbitControls -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/"
            }
        }
    </script>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script type="module">
        // NEW: Import the FBX and OrbitControls Loaders
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // Basic Scene Setup
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({
            canvas: document.querySelector('#bg'),
            antialias: true,
        });

        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.position.setZ(15); // Move camera back a bit to see the model

        // --- NEW: Add OrbitControls for free camera movement ---
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.screenSpacePanning = false;
        controls.minDistance = 5;
        controls.maxDistance = 50;


        // --- Create a group to hold the objects ---
        const objectGroup = new THREE.Group();
        scene.add(objectGroup);

        // --- Shops Information --
        const basicShopColor = 0xC1B36F;
        const selectedShopColor = 0xDC8454;
        const residentialColor = 0xCEC4C4;
        const floorColor = 0x9A8585

        const shopsID = [1,2,3,15,16,17,20,21,23,27,29,31];
        const shopsNameID = shopsID.map((id) => 'edificio_' + id)
        const shoppingCenterID = [4,5,6,30];
        const shoppingCenterNameID = shoppingCenterID.map((id) => 'edificio_' + id);
        const shopDefaultTitle = "Tienda";
        const shopDefaultDescription = "Esta es una tienda"
        const shoppingCenterDefaultTitle = "Galería";
        const shoppingCenterDefaultDescription = "Esta es una galería"
        const defaultAddress = "Calle Falsa 123"

        // -- Dummy Data --
        const shopInfo = [
            {id: "edificio_1", name: "Nómades foods", address: "Av. Irarrázaval 700, Ñuñoa", description: "Cafetería y panadería que ofrece consumo en el local, para llevar o entrega a domicilio. Ofrecen opciones veganas, opciones vegetarianas y opciones orgánicas. Hora de apertura: Lunes a martes desde 8:00 am hasta 9:00 pm – Sábado y Domingo desde 10:00 am hasta 8:30 pm. "},
            {id: "edificio_31", name: "Ristorante y Trattoria Da Noi", address: "Av. Italia 1791, Ñuñoa", description: "Restaurante Italiano que ofrece consumo en el local, para llevar o entrega a domicilio. Ofrecen alcohol, opciones veganas, opciones vegetarianas y accesibilidad para personas en silla de ruedas. Hora de apertura: Lunes desde 12:00 pm hasta 7:00 pm – Martes a Sábado desde 12:00 pm hasta 9:30 pm – Domingos desde 12:00 pm hasta 5:00 pm. "}
        ]


        // --- FBX MODEL LOADING ---
        const loader = new FBXLoader();
        loader.load('modelos_fbx/mapa_barrio_italia_v4_cuadra.fbx', function (fbx) {
            
            fbx.traverse(function (child) {
                if (child.isMesh) {
                    
                    const selectedShop = shopInfo.find(shop => shop.id == child.name) // Checks if the shop is included on the dummy data array
                    if(!selectedShop){

                        // -- Setup for a shop -- 
                        if (shopsNameID.includes(child.name)) {
                            child.material = new THREE.MeshStandardMaterial({ color: basicShopColor });
                            
                            child.userData = { 
                                action: 'modal',
                                id: child.name,
                                originalColor: basicShopColor, 
                                hoverColor: selectedShopColor, 
                                hoverText: shopDefaultTitle,
                                shopDescription: shopDefaultDescription,
                                shopAddress: defaultAddress
                            };
                        }

                        // -- Setup for a shopping center -- 
                        else if (shoppingCenterNameID.includes(child.name)) { 
                            child.material = new THREE.MeshStandardMaterial({ color: basicShopColor });
                            
                            child.userData = { 
                                action: 'navigate',
                                id: child.name,
                                url: 'galeria_1.html',
                                originalColor: basicShopColor, 
                                hoverColor: selectedShopColor,     
                                hoverText: shoppingCenterDefaultTitle
                            };
                        }

                        // -- Setup for the floor -- 
                        else if (child.name == "suelo"){
                            child.material = new THREE.MeshStandardMaterial({ color: floorColor });
                        }
                        
                        // --- Setup residential building ---
                        else{
                            child.material = new THREE.MeshStandardMaterial({ color: residentialColor });
                        }
                    }
                    else{
                        child.material = new THREE.MeshStandardMaterial({ color: basicShopColor });
                        
                        child.userData = { 
                            action: 'modal',
                            id: child.name,
                            originalColor: basicShopColor, 
                            hoverColor: selectedShopColor, 
                            hoverText: selectedShop.name,
                            shopDescription: shopDefaultDescription,
                            shopAddress: defaultAddress
                        };
                    }
                }
            });

            // Add the loaded model to the group
            objectGroup.add(fbx);

        }, undefined, function (error) {
            console.error(error);
            document.getElementById('info').textContent = "Error: Could not load 3D model. Check console for details.";
        });


        // --- Lighting ---
        const pointLight = new THREE.PointLight(0xffffff, 1.2);
        pointLight.position.set(20, 20, 20);
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(pointLight, ambientLight);


        // --- Interactivity Setup ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let intersectedObject = null;
        
        // --- Bootstrap Modal Instance ---
        const cubeModal = new bootstrap.Modal(document.getElementById('cubeModal'));

        function onMouseMove(event) {
            // Update mouse coordinates for raycasting
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
        }

        function onClick(event) {
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(objectGroup.children, true);

            if (intersects.length > 0) {
                const clickedObject = intersects[0].object;
                
                // Perform action based on custom user data
                if (clickedObject.userData.action === 'navigate') {
                    window.location.href = clickedObject.userData.url;

                } else if (clickedObject.userData.action === 'modal') {
                    const selectedShop = shopInfo.find(shop => shop.id == clickedObject.userData.id) // Checks if the shop is included on the dummy data array

                    if(!selectedShop){
                        const modalBody = document.getElementById('shopDescription');
                        modalBody.textContent = clickedObject.userData.shopDescription;

                        const modalTitle = document.getElementById('shopTitle');
                        modalTitle.textContent = clickedObject.userData.hoverText;

                        const modalAddress = document.getElementById('shopAddress');
                        modalAddress.textContent = clickedObject.userData.shopAddress;
                    }
                    else{
                        const modalBody = document.getElementById('shopDescription');
                        modalBody.textContent = selectedShop.description;

                        const modalTitle = document.getElementById('shopTitle');
                        modalTitle.textContent = selectedShop.name;

                        const modalAddress = document.getElementById('shopAddress');
                        modalAddress.textContent = selectedShop.address;
                    }
                    cubeModal.show();
                }
            }
        }
        
        // --- Event Listeners ---
        window.addEventListener('mousemove', onMouseMove, false);
        window.addEventListener('click', onClick, false);


        // --- Responsiveness ---
        window.addEventListener('resize', onWindowResize, false);

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);

            // Required for smooth camera controls
            controls.update();

            // --- Hover Logic ---
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(objectGroup.children, true);

            let newIntersectedObject = null;
            // Find the first object that has our custom data
            for (let i = 0; i < intersects.length; i++) {
                if (intersects[i].object.userData.action) {
                    newIntersectedObject = intersects[i].object;
                    break;
                }
            }

            if (intersectedObject !== newIntersectedObject) {
                if (intersectedObject) {
                    intersectedObject.material.color.set(intersectedObject.userData.originalColor);
                }
                intersectedObject = newIntersectedObject;
                if (intersectedObject) {
                     intersectedObject.material.color.set(intersectedObject.userData.hoverColor);
                }
            }
            
            // --- Tooltip Logic ---
           const tooltip = document.getElementById('tooltip');
            if (intersectedObject) {
                tooltip.style.display = 'block';
                tooltip.textContent = intersectedObject.userData.hoverText;

                // --- NEW ROBUST TOOLTIP POSITIONING ---
                // Create a bounding box to find the object's visual center
                const box = new THREE.Box3().setFromObject(intersectedObject);
                const center = box.getCenter(new THREE.Vector3());

                // Project the center point to 2D screen space
                center.project(camera);

                const translateX = (center.x * 0.5 + 0.5) * renderer.domElement.clientWidth;
                const translateY = (-center.y * 0.5 + 0.5) * renderer.domElement.clientHeight;
                
                tooltip.style.left = translateX + 'px';
                tooltip.style.top = translateY + 'px';
            } else {
                tooltip.style.display = 'none';
            }

            renderer.render(scene, camera);
        }

        // Start the animation
        animate();
    </script>
</body>
</html>
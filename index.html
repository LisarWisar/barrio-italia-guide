<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive 3D Scene</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #111827; /* bg-gray-900 */
        }
        canvas {
            display: block;
        }
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            z-index: 100;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 1.125rem; /* text-lg */
        }
        #tooltip {
            position: absolute;
            display: none;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            pointer-events: none; /* So it doesn't interfere with mouse events on the canvas */
            font-family: 'Inter', sans-serif;
            transform: translate(-50%, -120%); /* Offset to appear above the cursor */
        }
        /* Style for the modal to fit the dark theme */
        .modal-content {
            background-color: #2d3748;
            color: white;
        }
        .modal-header {
            border-bottom: 1px solid #4a5568;
        }
        .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
    </style>
</head>
<body>

    <div id="info">Use your mouse to navigate the scene.</div>
    <div id="tooltip"></div>
    <canvas id="bg"></canvas>

    <!-- Bootstrap Modal HTML -->
    <div class="modal fade" id="cubeModal" tabindex="-1" aria-labelledby="cubeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cubeModalLabel"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="cubeModalBody">
                    <!-- Content will be set by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Import Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- IMPORTANT: Add support for loading FBX files and OrbitControls -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/"
            }
        }
    </script>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script type="module">
        // NEW: Import the FBX and OrbitControls Loaders
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // Basic Scene Setup
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({
            canvas: document.querySelector('#bg'),
            antialias: true,
        });

        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.position.setZ(15); // Move camera back a bit to see the model

        // --- NEW: Add OrbitControls for free camera movement ---
        const controls = new OrbitControls(camera, renderer.domElement);
   /*      controls.enableDamping = true; // Makes movement feel smoother
        controls.dampingFactor = 0.05; */
        controls.screenSpacePanning = false;
        controls.minDistance = 5;
        controls.maxDistance = 50;


        // --- Create a group to hold the objects ---
        const objectGroup = new THREE.Group();
        scene.add(objectGroup);

        // --- Shops Information --
        const basicShopColor = 0xC1B36F;
        const selectedShopColor = 0xDC8454;
        const residentialColor = 0xCEC4C4;

        const shopsID = [1,2,3,15,16,17,20,21,23,27,29,31];
        const shopsName = shopsID.map((id) => 'edificio_' + id)
        const shoppingCenterID = [4,5,6,30];
        const shoppingCenterName = shoppingCenterID.map((id) => 'edificio_' + id)
        const shopDefaultTitle = "Tienda";
        const shopDefaultDescription = "Esta es una tienda"
        const shoppingCenterDefaultTitle = "Galería";
        const shoppingCenterDefaultDescription = "Esta es una galería"
        const floorColor = 0x9A8585


        // --- FBX MODEL LOADING ---
        const loader = new FBXLoader();
        loader.load('modelos_fbx/mapa_barrio_italia_v4_cuadra.fbx', function (fbx) {
            
            fbx.traverse(function (child) {
                console.log(child.name);
                if (child.isMesh) {
                    
                    // -- Setup for a shop -- 
                    if (shopsName.includes(child.name)) {
                         child.material = new THREE.MeshStandardMaterial({ color: basicShopColor });
                         
                         child.userData = { 
                            action: 'modal',
                            originalColor: basicShopColor, 
                            hoverColor: selectedShopColor, 
                            hoverText: shopDefaultTitle,
                            shopDescription: shopDefaultDescription
                        };
                    }

                    // -- Setup for a shopping center -- 
                    else if (shoppingCenterName.includes(child.name)) { 
                        child.material = new THREE.MeshStandardMaterial({ color: basicShopColor });
                        
                        child.userData = { 
                            action: 'navigate',
                            url: 'galeria_1.html',
                            originalColor: basicShopColor, 
                            hoverColor: selectedShopColor,     
                            hoverText: shoppingCenterDefaultTitle
                        };
                    }

                    // -- Setup for the floor -- 
                    else if (child.name == "suelo"){
                        child.material = new THREE.MeshStandardMaterial({ color: floorColor });
                    }
                    
                    // --- Setup edificio residencial ---
                    else{
                        child.material = new THREE.MeshStandardMaterial({ color: residentialColor });
                    }

                }
            });

            // Add the loaded model to the group
            objectGroup.add(fbx);

        }, undefined, function (error) {
            console.error(error);
            document.getElementById('info').textContent = "Error: Could not load 3D model. Check console for details.";
        });


        // --- Lighting ---
        const pointLight = new THREE.PointLight(0xffffff, 1.2);
        pointLight.position.set(20, 20, 20);
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(pointLight, ambientLight);


        // --- Interactivity Setup ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let intersectedObject = null;
        
        // --- Bootstrap Modal Instance ---
        const cubeModal = new bootstrap.Modal(document.getElementById('cubeModal'));

        function onMouseMove(event) {
            // Update mouse coordinates for raycasting
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
        }

        function onClick(event) {
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(objectGroup.children, true);

            if (intersects.length > 0) {
                const clickedObject = intersects[0].object;
                
                // Perform action based on custom user data
                if (clickedObject.userData.action === 'navigate') {
                    window.location.href = clickedObject.userData.url;

                } else if (clickedObject.userData.action === 'modal') {
                    const modalBody = document.getElementById('cubeModalBody');
                    modalBody.textContent = clickedObject.userData.shopDescription;

                    const modalTitle = document.getElementById('cubeModalLabel');
                    modalTitle.textContent = clickedObject.userData.hoverText;
                    cubeModal.show();
                }
            }
        }
        
        // --- Event Listeners ---
        window.addEventListener('mousemove', onMouseMove, false);
        window.addEventListener('click', onClick, false);


        // --- Responsiveness ---
        window.addEventListener('resize', onWindowResize, false);

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);

            // Required for smooth camera controls
            controls.update();

            // --- Hover Logic ---
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(objectGroup.children, true);

            let newIntersectedObject = null;
            // Find the first object that has our custom data
            for (let i = 0; i < intersects.length; i++) {
                if (intersects[i].object.userData.action) {
                    newIntersectedObject = intersects[i].object;
                    break;
                }
            }

            if (intersectedObject !== newIntersectedObject) {
                if (intersectedObject) {
                    intersectedObject.material.color.set(intersectedObject.userData.originalColor);
                }
                intersectedObject = newIntersectedObject;
                if (intersectedObject) {
                     intersectedObject.material.color.set(intersectedObject.userData.hoverColor);
                }
            }
            
            // --- Tooltip Logic ---
           const tooltip = document.getElementById('tooltip');
            if (intersectedObject) {
                tooltip.style.display = 'block';
                tooltip.textContent = intersectedObject.userData.hoverText;

                // --- NEW ROBUST TOOLTIP POSITIONING ---
                // Create a bounding box to find the object's visual center
                const box = new THREE.Box3().setFromObject(intersectedObject);
                const center = box.getCenter(new THREE.Vector3());

                // Project the center point to 2D screen space
                center.project(camera);

                const translateX = (center.x * 0.5 + 0.5) * renderer.domElement.clientWidth;
                const translateY = (-center.y * 0.5 + 0.5) * renderer.domElement.clientHeight;
                
                tooltip.style.left = translateX + 'px';
                tooltip.style.top = translateY + 'px';
            } else {
                tooltip.style.display = 'none';
            }

            renderer.render(scene, camera);
        }

        // Start the animation
        animate();
    </script>
</body>
</html>